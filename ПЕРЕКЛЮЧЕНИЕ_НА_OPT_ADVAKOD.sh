#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è production –Ω–∞ /opt/advakod

set -e

OLD_DIR="/root/advakod_backup_20251029_005854"
NEW_DIR="/opt/advakod"

echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ production –Ω–∞ $NEW_DIR..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Å—Ç–∞—Ä–æ–π –ø–∞–ø–∫–µ
echo "1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ $OLD_DIR..."
cd "$OLD_DIR"
docker-compose -f docker-compose.prod.yml down

# 2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É—é –ø–∞–ø–∫—É
echo "2. –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ $NEW_DIR..."
cd "$NEW_DIR"
docker-compose -f docker-compose.prod.yml up -d

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
echo "3. –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
sleep 10
docker-compose -f docker-compose.prod.yml ps

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "4. –ü—Ä–æ–≤–µ—Ä—è—é –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 20
docker exec advakod_backend curl -f http://localhost:8000/api/v1/health || {
    echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!"
    exit 1
}

echo "‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"

