from typing import Optional, AsyncGenerator
import time
import asyncio
import logging

logger = logging.getLogger(__name__)


class MockSaigaService:
    """Мок-сервис для тестирования без реальной модели Saiga Mistral 7B"""
    
    def __init__(self):
        logger.info("Mock Saiga сервис инициализирован")
    
    def generate_response(
        self, 
        prompt: str, 
        max_tokens: int = 512,
        temperature: float = 0.7,
        top_p: float = 0.9
    ) -> str:
        """Генерация мок-ответа"""
        time.sleep(1)  # Имитируем время обработки
        
        # Простые ответы на основе ключевых слов
        if "договор" in prompt.lower():
            return """На основе анализа вашего вопроса о договоре, рекомендую:

1. **Проверьте существенные условия договора** согласно ст. 432 ГК РФ
2. **Обратите внимание на предмет договора** - он должен быть четко определен
3. **Проверьте сроки исполнения** и ответственность сторон
4. **Убедитесь в правоспособности контрагента**

⚠️ **Важно**: Для сложных договоров рекомендую консультацию с живым юристом.

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""
        
        elif "105" in prompt or "убийство" in prompt.lower():
            return """**Статья 105 УК РФ - Убийство**

**Ответственность по статье 105:**

1. **Часть 1** (простое убийство):
   - Лишение свободы на срок от 6 до 15 лет
   - Ограничение свободы на срок до 2 лет (дополнительно)

2. **Часть 2** (квалифицированное убийство):
   - Лишение свободы на срок от 8 до 20 лет
   - Пожизненное лишение свободы
   - Смертная казнь (приостановлена мораторием)

**Квалифицирующие признаки (часть 2):**
- Убийство двух или более лиц
- Убийство лица, заведомо для виновного находящегося в беспомощном состоянии
- Убийство, сопряженное с похищением человека
- Убийство женщины, заведомо для виновного находящейся в состоянии беременности
- Убийство, совершенное с особой жестокостью

⚠️ **Важно**: Это очень серьезное преступление. Рекомендую немедленно обратиться к адвокату.

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""

        elif "159" in prompt or "мошенничество" in prompt.lower():
            return """**Статья 159 УК РФ - Мошенничество**

**Сроки наказания по статье 159:**

1. **Часть 1** (простое мошенничество):
   - Штраф до 120 000 ₽ или в размере зарплаты за период до 1 года
   - Обязательные работы до 360 часов
   - Исправительные работы до 1 года
   - Ограничение свободы до 2 лет
   - Принудительные работы до 2 лет
   - Арест до 4 месяцев
   - Лишение свободы до 2 лет

2. **Часть 2** (с причинением значительного ущерба):
   - Штраф до 300 000 ₽ или в размере зарплаты за период до 2 лет
   - Обязательные работы до 480 часов
   - Исправительные работы до 2 лет
   - Принудительные работы до 5 лет
   - Лишение свободы до 5 лет

3. **Часть 3** (с использованием служебного положения):
   - Штраф от 100 000 до 500 000 ₽ или в размере зарплаты за период от 1 до 3 лет
   - Лишение права занимать определенные должности до 5 лет
   - Принудительные работы до 5 лет
   - Лишение свободы до 6 лет

⚠️ **Важно**: Конкретный срок зависит от обстоятельств дела и наличия отягчающих факторов.

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""

        elif "зарегистрировать" in prompt.lower() and "ип" in prompt.lower():
            return """**Регистрация ИП (Индивидуального предпринимателя)**

**Пошаговая инструкция:**

1. **Подготовка документов**:
   - Паспорт РФ
   - ИНН (если нет - получить в налоговой)
   - Заявление по форме Р21001
   - Квитанция об оплате госпошлины (800 ₽)

2. **Подача документов**:
   - Лично в налоговую по месту жительства
   - Через МФЦ "Мои документы"
   - Онлайн через сайт ФНС (с ЭЦП)

3. **Сроки регистрации**: 3 рабочих дня

4. **После регистрации**:
   - Получить лист записи ЕГРИП
   - Выбрать налоговый режим (УСН, патент, самозанятость)
   - Зарегистрироваться в ПФР и ФСС

⚠️ **Важно**: Рекомендую консультацию с юристом для выбора оптимального налогового режима.

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""

        elif "налог" in prompt.lower() or ("ип" in prompt.lower() and "налог" in prompt.lower()):
            return """По вопросам налогообложения ИП:

1. **Налоговые режимы для ИП**:
   - УСН (6% с доходов или 15% с прибыли)
   - Патентная система налогообложения
   - Самозанятость (4% с доходов)

2. **Обязательные платежи**:
   - Налоги по выбранному режиму
   - Страховые взносы (фиксированные + 1% с доходов свыше 300 000 ₽)

3. **Сроки подачи деклараций** зависят от выбранного режима

⚠️ **Рекомендация**: Обратитесь к налоговому консультанту для выбора оптимального режима.

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""

        elif "федеральный закон" in prompt.lower() or "что такое федеральный закон" in prompt.lower():
            return """**Федеральный закон** - это нормативный правовой акт, принимаемый Государственной Думой Российской Федерации и одобряемый Советом Федерации РФ.

**Основные характеристики федерального закона:**

1. **Порядок принятия**:
   - Принимается Государственной Думой большинством голосов
   - Одобряется Советом Федерации (или считается одобренным через 14 дней)
   - Подписывается Президентом РФ

2. **Юридическая сила**:
   - Выше подзаконных актов (указов, постановлений)
   - Ниже Конституции РФ и федеральных конституционных законов
   - Действует на всей территории РФ

3. **Виды федеральных законов**:
   - Обычные федеральные законы
   - Федеральные конституционные законы (по вопросам, указанным в Конституции)

4. **Структура**:
   - Наименование
   - Преамбула (при необходимости)
   - Основная часть (статьи)
   - Заключительные положения

**Примеры**: ФЗ "О защите прав потребителей", ФЗ "О некоммерческих организациях", ФЗ "О банках и банковской деятельности".

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""
        
        else:
            return """Спасибо за ваш вопрос! Я готов помочь с юридическими вопросами по российскому законодательству.

**Что я могу помочь:**
- Анализ договоров и документов
- Консультации по налогообложению
- Вопросы по трудовому праву
- Помощь с регистрацией ИП/ООО

**Попробуйте задать более конкретный вопрос**, например:
- "Как проверить договор на оказание услуг?"
- "Какие налоги платит ИП на УСН?"
- "Как расторгнуть трудовой договор?"

⚠️ **Помните**: ИИ не заменяет живого юриста в сложных случаях.

*Этот ответ сгенерирован демо-версией ИИ-юриста*"""
    
    def create_legal_prompt(self, question: str, context: Optional[str] = None) -> str:
        """Создание промпта для юридических вопросов"""
        if context:
            return f"Контекст: {context}\n\nВопрос: {question}"
        else:
            return f"Вопрос: {question}"

    async def stream_response(
        self,
        prompt: str,
        max_tokens: int = 512,
        temperature: float = 0.7,
        top_p: float = 0.9
    ) -> AsyncGenerator[str, None]:
        """Потоковая отдача мок-ответа небольшими частями для SSE."""
        full_text = self.generate_response(prompt, max_tokens=max_tokens, temperature=temperature, top_p=top_p)
        # Режем ответ на небольшие чанки для имитации генерации
        chunk_size = 40
        for i in range(0, len(full_text), chunk_size):
            yield full_text[i:i+chunk_size]
            await asyncio.sleep(0.05)


# Глобальный экземпляр мок-сервиса
mock_saiga_service = MockSaigaService()
