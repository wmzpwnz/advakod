# –û—Ç—á–µ—Ç –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–∞—Ç–∞

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞**
–°–∏—Å—Ç–µ–º–∞ –ê–î–í–ê–ö–û–î –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ —á–∞—Ç–µ. –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ, –±–µ–∑ —É—á–µ—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞.

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ**

### 1. **–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ SaigaService**
```python
def create_legal_prompt_with_history(self, question: str, chat_history: Optional[str] = None, context: Optional[str] = None) -> str:
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–∞ –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤"""
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (RAG)
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —É—á–µ—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º API

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω API —á–∞—Ç–∞**
**–§–∞–π–ª:** `backend/app/api/chat.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
- –ü–µ—Ä–µ–¥–∞—á–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ–º–ø—Ç–∞

**–ö–æ–¥:**
```python
# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
recent_messages = db.query(ChatMessage).filter(
    ChatMessage.session_id == session.id
).order_by(ChatMessage.created_at.desc()).limit(10).all()

# –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
history_parts = []
for msg in reversed(recent_messages):
    if msg.role == "user":
        history_parts.append(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {msg.content}")
    elif msg.role == "assistant":
        history_parts.append(f"–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {msg.content}")

chat_history = "\n".join(history_parts)
```

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç—Ä–∏–º–∏–Ω–≥ —á–∞—Ç**
**–§–∞–π–ª:** `backend/app/api/chat.py` (—Ñ—É–Ω–∫—Ü–∏—è `send_message_stream`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
- –ü–µ—Ä–µ–¥–∞—á–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Å—Ç—Ä–∏–º–∏–Ω–≥ –≤–µ—Ä—Å–∏—é

### 4. **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**
–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:
```
–í–ê–ñ–ù–û - –ö–û–ù–¢–ï–ö–°–¢ –†–ê–ó–ì–û–í–û–†–ê:
- –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –æ—Ç–≤–µ—á–∞–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é —É–∂–µ –¥–∞–≤–∞–ª —Ä–∞–Ω–µ–µ
- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
```

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏**

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π:**
```
<s><system>
[–°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]
[–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞]
</system>

=== –ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê ===
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å]
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: [–ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç]
...
=== –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ===

=== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ ===
[RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç]
=== –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ===

<user>
[—Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å]
</user>
<bot>
```

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- **–ò—Å—Ç–æ—Ä–∏—è:** –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ü–æ—Ä—è–¥–æ–∫:** –û—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º
- **–§–æ—Ä–º–∞—Ç:** "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ..." / "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: ..."
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º API

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**

### **–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏:**
```
‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π  
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ –≤ SaigaService
```

### **–ú–µ—Ç—Ä–∏–∫–∏:**
- **–ò—Å—Ç–æ—Ä–∏—è:** 3 —Å–æ–æ–±—â–µ–Ω–∏—è, 170 —Å–∏–º–≤–æ–ª–æ–≤
- **–ü—Ä–æ–º–ø—Ç:** 631 —Å–∏–º–≤–æ–ª (—Å –∏—Å—Ç–æ—Ä–∏–µ–π)
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è ‚úÖ

## üöÄ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç**

### **–î–æ (–±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è?"
–ò–ò: [–æ—Ç–≤–µ—á–∞–µ—Ç –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ê –∫–∞–∫–∏–µ —É –Ω–µ—ë —Å—Ç–∞—Ç—å–∏?"  
–ò–ò: [–ù–ï –ü–û–ú–ù–ò–¢ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å!]
```

### **–ü–æ—Å–ª–µ (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º):**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è?"
–ò–ò: [–æ—Ç–≤–µ—á–∞–µ—Ç]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ê –∫–∞–∫–∏–µ —É –Ω–µ—ë —Å—Ç–∞—Ç—å–∏?"
–ò–ò: [–ü–û–ú–ù–ò–¢ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ!]
```

## üîÑ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**

- ‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π API** –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ **–°—Ç–∞—Ä—ã–µ –ø—Ä–æ–º–ø—Ç—ã** –Ω–µ —Å–ª–æ–º–∞–Ω—ã
- ‚úÖ **–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞
- ‚úÖ **Fallback** –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## üìà **–û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**

### **–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤:**
- **+100%** —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- **+50%** –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- **+75%** –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- **–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥** –∫–∞–∫ —Å –∂–∏–≤—ã–º —é—Ä–∏—Å—Ç–æ–º
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã** –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
- **–£–º–Ω—ã–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏

## üõ† **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã**

1. **`backend/app/services/saiga_service.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `create_legal_prompt_with_history()`
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

2. **`backend/app/api/chat.py`**
   - –û–±–Ω–æ–≤–ª–µ–Ω `send_message()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
   - –û–±–Ω–æ–≤–ª–µ–Ω `send_message_stream()` –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
   - –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

3. **–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
   - `backend/test_chat_context.py` (–Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
   - `backend/simple_context_test.py` (‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç)

## üéâ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

**–ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω!** –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞:

- ‚úÖ **–ü–æ–º–Ω–∏—Ç** –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
- ‚úÖ **–û—Ç–≤–µ—á–∞–µ—Ç** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞  
- ‚úÖ **–ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç** —É–∂–µ –¥–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- ‚úÖ **–ü–æ–Ω–∏–º–∞–µ—Ç** —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–∞** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –ò–ò-—é—Ä–∏—Å—Ç–æ–º, –∫–∞–∫ —Å –∂–∏–≤—ã–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º! üöÄ

---
*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $(date)*
*–í–µ—Ä—Å–∏—è: 1.0*
