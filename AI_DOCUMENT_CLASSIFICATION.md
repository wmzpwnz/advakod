# AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

### 1. –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ (Rule-Based)
**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞, ID –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ —Ç–µ–∫—Å—Ç–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞: "–µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç '–∫–æ–¥–µ–∫—Å' ‚Üí codex"
- –ë—ã—Å—Ç—Ä–æ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)
- –ë–µ—Å–ø–ª–∞—Ç–Ω–æ

**–ü–ª—é—Å—ã:**
- ‚úÖ –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç API
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω
- ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ú–æ–∂–µ—Ç –æ—à–∏–±–∞—Ç—å—Å—è –Ω–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
- ‚ùå –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
- ‚ùå –ù–µ –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–¥—Ç–∏–ø—ã

**–ü—Ä–∏–º–µ—Ä:**
```python
# –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ
if '–∫–æ–¥–µ–∫—Å' in file_name.lower():
    return "codex"
```

---

### 2. AI-–ø–æ–¥—Ö–æ–¥ (LLM-Based)
**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —è–∑—ã–∫–æ–≤—É—é –º–æ–¥–µ–ª—å (LLM) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –ü–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–º—ã—Å–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ú–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏

**–ü–ª—é—Å—ã:**
- ‚úÖ –¢–æ—á–Ω–µ–µ –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –ü–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
- ‚úÖ –ú–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–¥—Ç–∏–ø—ã
- ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –Ω–æ–≤—ã–º —Ç–∏–ø–∞–º

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ (—Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)
- ‚ùå –¢—Ä–µ–±—É–µ—Ç API/–º–æ–¥–µ–ª—å
- ‚ùå –ú–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å –¥–µ–Ω–µ–≥ (–µ—Å–ª–∏ API)
- ‚ùå –ú–æ–∂–µ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä–æ–≤–∞—Ç—å

**–ü—Ä–∏–º–µ—Ä:**
```python
# AI-–∞–Ω–∞–ª–∏–∑
prompt = f"–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞: {text_content}"
response = llm.generate(prompt)
# –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å: "–≠—Ç–æ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω –æ –∑–∞—â–∏—Ç–µ –ø—Ä–∞–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π"
```

---

## üéØ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ö–æ–º–±–∏–Ω–∞—Ü–∏—è –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤:**

1. **–°–Ω–∞—á–∞–ª–∞** - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª
2. **–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã** - –∏—Å–ø–æ–ª—å–∑—É–µ–º AI
3. **–ö—ç—à–∏—Ä—É–µ–º** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤
- ‚úÖ –¢–æ—á–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö
- ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏/–∫–∞—á–µ—Å—Ç–≤–∞

---

## üíª –†–µ–∞–ª–∏–∑–∞—Ü–∏—è AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ unified_llm_service

```python
from app.services.unified_llm_service import unified_llm_service

async def determine_document_type_ai(text_content: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é AI"""
    
    prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º—É –ø—Ä–∞–≤—É. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞.

–î–æ–∫—É–º–µ–Ω—Ç:
{text_content[:2000]}

–¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
- codex: –ö–æ–¥–µ–∫—Å (–ì–ö –†–§, –£–ö –†–§, –¢–ö –†–§ –∏ —Ç.–¥.)
- federal_law: –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω (–§–ó)
- supreme_court_resolution: –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –í–µ—Ä—Ö–æ–≤–Ω–æ–≥–æ –°—É–¥–∞ –†–§
- resolution: –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞, –º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤)
- decree: –£–∫–∞–∑ –ü—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –†–§
- order: –ü—Ä–∏–∫–∞–∑ (–º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤, –≤–µ–¥–æ–º—Å—Ç–≤)
- other: –î—Ä—É–≥–æ–µ

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º (—Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞):"""

    try:
        response = await unified_llm_service.generate_async(
            prompt=prompt,
            max_tokens=10,
            temperature=0.1  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        )
        
        doc_type = response.strip().lower()
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        valid_types = ['codex', 'federal_law', 'supreme_court_resolution', 
                      'resolution', 'decree', 'order', 'other']
        
        if doc_type in valid_types:
            return doc_type
        else:
            return 'other'
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
        return 'other'
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (JSON)

```python
async def determine_document_type_ai_structured(text_content: str) -> Dict[str, Any]:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""
    
    prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º—É –ø—Ä–∞–≤—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ –≤–µ—Ä–Ω–∏ JSON.

–î–æ–∫—É–º–µ–Ω—Ç:
{text_content[:2000]}

–í–µ—Ä–Ω–∏ JSON:
{{
    "type": "codex|federal_law|supreme_court_resolution|resolution|decree|order|other",
    "confidence": 0.0-1.0,
    "reason": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ",
    "subtype": "–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ç–∏–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π', '—É–≥–æ–ª–æ–≤–Ω—ã–π')"
}}"""

    try:
        response = await unified_llm_service.generate_async(
            prompt=prompt,
            max_tokens=200,
            temperature=0.2
        )
        
        # –ü–∞—Ä—Å–∏–º JSON
        import json
        result = json.loads(response)
        return result
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
        return {"type": "other", "confidence": 0.0}
```

---

## üîÑ –ì–∏–±—Ä–∏–¥–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
async def determine_document_type_hybrid(
    file_name: str, 
    document_id: str, 
    text_content: str = ""
) -> str:
    """–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –ø—Ä–∞–≤–∏–ª–∞ + AI"""
    
    # –®–∞–≥ 1: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª
    rule_based_type = determine_document_type(file_name, document_id, text_content)
    
    # –®–∞–≥ 2: –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω—ã - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É
    if rule_based_type != 'other':
        return rule_based_type
    
    # –®–∞–≥ 3: –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º AI
    ai_type = await determine_document_type_ai(text_content)
    return ai_type
```

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç–æ–¥ | –°–∫–æ—Ä–æ—Å—Ç—å | –¢–æ—á–Ω–æ—Å—Ç—å | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-------|----------|----------|-----------|
| Rule-Based | ~1 –º—Å | 85-90% | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ |
| AI-Based | ~500-2000 –º—Å | 95-98% | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç API |
| –ì–∏–±—Ä–∏–¥–Ω—ã–π | ~1-500 –º—Å | 92-96% | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è |

---

## üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Vistral-24B (–ª–æ–∫–∞–ª—å–Ω–æ)

```python
# –í vector_store_service.py
from app.services.unified_llm_service import unified_llm_service

async def determine_document_type_smart(
    file_name: str,
    document_id: str, 
    text_content: str = ""
) -> str:
    """–£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    
    # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∫–æ–¥–µ–∫—Å–æ–≤
    if document_id.startswith('codex_') or '–∫–æ–¥–µ–∫—Å' in file_name.lower():
        return "codex"
    
    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º AI
    if text_content:
        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–æ–¥–Ω–æ —Å–ª–æ–≤–æ: codex, federal_law, supreme_court_resolution, resolution, decree, order, other):

{text_content[:1500]}"""
        
        try:
            response = await unified_llm_service.generate_async(
                prompt=prompt,
                max_tokens=20,
                temperature=0.1
            )
            return response.strip().lower()
        except:
            return "other"
    
    return "other"
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ rule-based (–±—ã—Å—Ç—Ä–æ)
2. **–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤** - –¥–æ–±–∞–≤—å—Ç–µ AI –∫–∞–∫ fallback
3. **–î–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
4. **–ö—ç—à–∏—Ä—É–π—Ç–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã AI –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

## üí° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
from functools import lru_cache
import hashlib

@lru_cache(maxsize=1000)
def get_cached_type(text_hash: str) -> str:
    """–ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    # ...
```

### –ë–∞—Ç—á–∏–Ω–≥
```python
async def classify_batch(texts: List[str]) -> List[str]:
    """–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞ —Ä–∞–∑"""
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤ –æ–¥–∏–Ω –ø—Ä–æ–º–ø—Ç
    # –≠–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∏ —Ç–æ–∫–µ–Ω—ã
```

---

## üìä –ò—Ç–æ–≥

**–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ (rule-based)** - –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤–∞—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
- –ö–æ–¥–µ–∫—Å—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Ç–æ—á–Ω–æ
- –ó–∞–∫–æ–Ω—ã –∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è - –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- –ë—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ

**AI-–ø–æ–¥—Ö–æ–¥** - –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è:
- –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥—Ç–∏–ø–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤—å—Ç–µ rule-based –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π, –¥–æ–±–∞–≤—å—Ç–µ AI –∫–∞–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π fallback –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.

