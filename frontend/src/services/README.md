# WebSocket Services

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —É—Å—Ç–æ–π—á–∏–≤—ã—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è ADVAKOD —Å–∏—Å—Ç–µ–º—ã.

## ResilientWebSocket

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** —Å exponential backoff
- ‚úÖ **Ping/Pong –º–µ—Ö–∞–Ω–∏–∑–º** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ **–û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç–∞—Ç—É—Å—ã** –¥–ª—è UI
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏
- ‚úÖ **Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```javascript
import ResilientWebSocket from '../services/ResilientWebSocket';

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
const ws = new ResilientWebSocket('wss://example.com/ws', {
  maxReconnectAttempts: 10,
  reconnectDelay: 1000,
  maxReconnectDelay: 30000,
  pingInterval: 30000,
  pongTimeout: 10000
});

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
ws.on('open', () => console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ'));
ws.on('message', (data) => console.log('–°–æ–æ–±—â–µ–Ω–∏–µ:', data));
ws.on('stateChange', (state) => console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ:', state));
ws.on('error', (error) => console.error('–û—à–∏–±–∫–∞:', error));

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
await ws.connect();

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
ws.send({ type: 'chat', message: '–ü—Ä–∏–≤–µ—Ç!' });

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
const status = ws.getStatus();
const userStatus = ws.getUserFriendlyStatus();
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

- `connecting` - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- `connected` - –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
- `reconnecting` - –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–∞–∑—Ä—ã–≤–∞
- `disconnected` - –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
- `failed` - –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### –°–æ–±—ã—Ç–∏—è

- `open` - –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `close` - –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
- `message` - –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `error` - –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
- `stateChange` - –ò–∑–º–µ–Ω–∏–ª–æ—Å—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `maxReconnectAttemptsReached` - –ò—Å—á–µ—Ä–ø–∞–Ω—ã –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## WebSocketStatus Component

React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üìä **–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä** –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- üîÑ **–ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- üìà **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- üé® **–¶–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚è∞ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ** –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```jsx
import WebSocketStatus from '../components/WebSocketStatus';

// –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
<WebSocketStatus websocket={websocket} />

// –° –¥–µ—Ç–∞–ª—è–º–∏ –∏ –∫–Ω–æ–ø–∫–æ–π –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
<WebSocketStatus 
  websocket={websocket}
  showDetails={true}
  onReconnect={() => websocket.reconnect()}
/>

// –ü–ª–∞–≤–∞—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
<div className="fixed top-4 right-4 z-50">
  <WebSocketStatus websocket={websocket} />
</div>
```

## useChatWebSocket Hook

React —Ö—É–∫ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ WebSocket –≤ —á–∞—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîå **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- üí¨ **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π** —á–∞—Ç–∞
- ‚å®Ô∏è **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏** —Å debounce
- üîÑ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏** —á–∞—Ç–∞
- üõë **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** –æ—Ç–≤–µ—Ç–æ–≤

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```javascript
import { useChatWebSocket } from '../hooks/useChatWebSocket';

const ChatComponent = () => {
  const {
    isConnected,
    connectionState,
    websocket,
    sendChatMessage,
    sendTyping,
    stopGeneration,
    forceReconnect
  } = useChatWebSocket(sessionId, handleNewMessage);

  return (
    <div>
      <WebSocketStatus websocket={websocket} onReconnect={forceReconnect} />
      {/* –û—Å—Ç–∞–ª—å–Ω–æ–π UI —á–∞—Ç–∞ */}
    </div>
  );
};
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# WebSocket URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
REACT_APP_WS_URL=wss://advacodex.com

# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
REACT_APP_WS_URL=ws://localhost:8000
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

```javascript
const defaultOptions = {
  maxReconnectAttempts: 10,     // –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  reconnectDelay: 1000,         // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å)
  maxReconnectDelay: 30000,     // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å)
  pingInterval: 30000,          // –ò–Ω—Ç–µ—Ä–≤–∞–ª ping (–º—Å)
  pongTimeout: 10000,           // –¢–∞–π–º–∞—É—Ç pong (–º—Å)
  connectionTimeout: 10000,     // –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–º—Å)
  maxQueueSize: 100             // –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
};
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ö–æ–¥—ã –∑–∞–∫—Ä—ã—Ç–∏—è WebSocket

- `1000` - –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è)
- `1003` - –û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ (–Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è)
- `1006` - –ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è)
- `1008` - –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è)
- `1011` - –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è)

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

1. **Exponential backoff**: –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–≤–∞–∏–≤–∞–µ—Ç—Å—è —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
2. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞**: –ù–µ –±–æ–ª–µ–µ 30 —Å–µ–∫—É–Ω–¥
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫**: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 10 –ø–æ–ø—ã—Ç–æ–∫
4. **–û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π**: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ WebSocket
npm test -- --testPathPattern="ResilientWebSocket|WebSocketStatus"

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
import { demonstrateResilientWebSocket } from './demo/websocket-demo';
demonstrateResilientWebSocket();
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

```javascript
const status = websocket.getStatus();
console.log({
  connected: status.connected,
  state: status.connectionState,
  attempts: status.reconnectAttempts,
  totalConnections: status.stats.totalConnections,
  totalMessages: status.stats.totalMessages,
  lastPong: status.lastPong
});
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–æ–±—ã—Ç–∏—è WebSocket –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `ResilientWebSocket:` –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏

–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ `.kiro/specs/websocket-ai-errors-fix/`:

- ‚úÖ **2.2**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ
- ‚úÖ **2.3**: Ping/pong –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è  
- ‚úÖ **6.3**: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: Ping –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ—á–µ—Ä–µ–¥—å**: –ú–∞–∫—Å–∏–º—É–º 100 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏
- **–£–º–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: –¢–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã**: –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º