# Конфигурация таймаутов AI-анализа

## Обзор

Система АДВАКОД была обновлена с увеличенными таймаутами для AI-анализа, чтобы обеспечить качественную обработку сложных правовых документов и запросов.

## Новые настройки таймаутов и токенов

### Основные таймауты

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `SAIGA_INFERENCE_TIMEOUT` | 300 секунд (5 минут) | Таймаут для инференса модели Saiga |
| `AI_DOCUMENT_ANALYSIS_TIMEOUT` | 300 секунд (5 минут) | Таймаут для анализа документов |
| `AI_CHAT_RESPONSE_TIMEOUT` | 120 секунд (2 минуты) | Таймаут для ответов в чате |
| `AI_COMPLEX_ANALYSIS_TIMEOUT` | 600 секунд (10 минут) | Таймаут для сложного анализа |
| `AI_EMBEDDINGS_TIMEOUT` | 60 секунд (1 минута) | Таймаут для генерации эмбеддингов |

### Настройки токенов

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `AI_DOCUMENT_ANALYSIS_TOKENS` | 4000 токенов | Максимальное количество токенов для анализа документов |
| `AI_CHAT_RESPONSE_TOKENS` | 2000 токенов | Максимальное количество токенов для ответов в чате |
| `AI_COMPLEX_ANALYSIS_TOKENS` | 6000 токенов | Максимальное количество токенов для сложного анализа |
| `AI_EMBEDDINGS_TOKENS` | 1000 токенов | Максимальное количество токенов для эмбеддингов |

### Предыдущие значения (для сравнения)

**Таймауты:**
- `SAIGA_INFERENCE_TIMEOUT`: 60 секунд → **300 секунд** (+400%)
- `AI_DOCUMENT_ANALYSIS_TIMEOUT`: 120 секунд → **300 секунд** (+150%)
- `AI_CHAT_RESPONSE_TIMEOUT`: не было → **120 секунд** (новая настройка)
- `AI_COMPLEX_ANALYSIS_TIMEOUT`: не было → **600 секунд** (новая настройка)
- `AI_EMBEDDINGS_TIMEOUT`: не было → **60 секунд** (новая настройка)

**Токены:**
- `AI_DOCUMENT_ANALYSIS_TOKENS`: 1000 токенов → **4000 токенов** (+300%)
- `AI_CHAT_RESPONSE_TOKENS`: 2000 токенов → **2000 токенов** (без изменений)
- `AI_COMPLEX_ANALYSIS_TOKENS`: не было → **6000 токенов** (новая настройка)
- `AI_EMBEDDINGS_TOKENS`: не было → **1000 токенов** (новая настройка)

## Обоснование увеличения

### Проблемы с предыдущими настройками

**Таймауты:**
1. **60 секунд для SAIGA_INFERENCE_TIMEOUT** было недостаточно для:
   - Анализа больших правовых документов (100+ страниц)
   - Сложных правовых запросов с множественными аспектами
   - Обработки документов с высокой детализацией

2. **120 секунд для анализа документов** было мало для:
   - Извлечения ключевой информации из объемных документов
   - Семантического анализа правовых концепций
   - Создания умных чанков с контекстом

**Токены:**
3. **1000 токенов для анализа документов** было критически мало для:
   - Качественного анализа сложных правовых документов
   - Извлечения всех важных правовых концепций
   - Детального анализа процедур и сроков
   - Полного описания ответственности и терминов

### Преимущества новых настроек

**Таймауты:**
1. **Качественный анализ**: Достаточно времени для глубокого анализа документов
2. **Стабильность**: Снижение количества таймаутов и ошибок
3. **Гибкость**: Разные таймауты для разных типов операций
4. **Масштабируемость**: Поддержка больших документов и сложных запросов

**Токены:**
5. **Детальный анализ**: 4000 токенов позволяют извлечь все важные правовые концепции
6. **Полнота информации**: Достаточно места для описания процедур, сроков и ответственности
7. **Качественные ответы**: 2000 токенов для чата обеспечивают развернутые ответы
8. **Сложный анализ**: 6000 токенов для особо сложных правовых случаев

## Конфигурация

### Файл config.env

```env
# AI Таймауты (в секундах)
SAIGA_INFERENCE_TIMEOUT=300
AI_DOCUMENT_ANALYSIS_TIMEOUT=300
AI_CHAT_RESPONSE_TIMEOUT=120
AI_COMPLEX_ANALYSIS_TIMEOUT=600
AI_EMBEDDINGS_TIMEOUT=60

# AI Токены (максимальное количество токенов для генерации)
AI_DOCUMENT_ANALYSIS_TOKENS=4000
AI_CHAT_RESPONSE_TOKENS=2000
AI_COMPLEX_ANALYSIS_TOKENS=6000
AI_EMBEDDINGS_TOKENS=1000
```

### Переменные окружения

Вы можете переопределить любые таймауты через переменные окружения:

```bash
export AI_DOCUMENT_ANALYSIS_TIMEOUT=600  # 10 минут для особо сложных документов
export AI_CHAT_RESPONSE_TIMEOUT=180      # 3 минуты для сложных чат-запросов
export AI_DOCUMENT_ANALYSIS_TOKENS=6000  # 6000 токенов для особо сложных документов
export AI_CHAT_RESPONSE_TOKENS=3000     # 3000 токенов для развернутых ответов
```

## Использование в коде

### Пример использования в сервисах

```python
from ..core.config import settings
import asyncio

# Анализ документа с таймаутом и токенами
analysis_result = await asyncio.wait_for(
    saiga_service.generate_response_async(
        prompt, 
        max_tokens=settings.AI_DOCUMENT_ANALYSIS_TOKENS
    ),
    timeout=settings.AI_DOCUMENT_ANALYSIS_TIMEOUT
)

# Чат с таймаутом и токенами
chat_response = await asyncio.wait_for(
    saiga_service.generate_response_async(
        prompt, 
        max_tokens=settings.AI_CHAT_RESPONSE_TOKENS
    ),
    timeout=settings.AI_CHAT_RESPONSE_TIMEOUT
)
```

### Обработка таймаутов

```python
try:
    result = await asyncio.wait_for(
        ai_service.process_request(request),
        timeout=settings.AI_DOCUMENT_ANALYSIS_TIMEOUT
    )
except asyncio.TimeoutError:
    logger.warning(f"⚠️ AI анализ превысил таймаут ({settings.AI_DOCUMENT_ANALYSIS_TIMEOUT} сек)")
    return {"error": "AI analysis timeout", "skipped": True}
```

## Мониторинг и отладка

### Логирование таймаутов

Система автоматически логирует:
- Предупреждения о превышении таймаутов
- Время обработки запросов
- Переключение на fallback сервисы

### Метрики производительности

- Среднее время обработки документов
- Процент успешных обработок
- Частота таймаутов по типам операций

## Рекомендации по настройке

### Для разработки
```env
AI_DOCUMENT_ANALYSIS_TIMEOUT=300  # 5 минут
AI_CHAT_RESPONSE_TIMEOUT=120       # 2 минуты
AI_DOCUMENT_ANALYSIS_TOKENS=4000  # 4000 токенов
AI_CHAT_RESPONSE_TOKENS=2000      # 2000 токенов
```

### Для продакшена
```env
AI_DOCUMENT_ANALYSIS_TIMEOUT=600   # 10 минут для сложных документов
AI_CHAT_RESPONSE_TIMEOUT=180      # 3 минуты для качественных ответов
AI_COMPLEX_ANALYSIS_TIMEOUT=900   # 15 минут для особо сложных случаев
AI_DOCUMENT_ANALYSIS_TOKENS=6000  # 6000 токенов для детального анализа
AI_CHAT_RESPONSE_TOKENS=3000     # 3000 токенов для развернутых ответов
AI_COMPLEX_ANALYSIS_TOKENS=8000  # 8000 токенов для сложных случаев
```

### Для высоконагруженных систем
```env
AI_DOCUMENT_ANALYSIS_TIMEOUT=300  # Баланс между качеством и скоростью
AI_CHAT_RESPONSE_TIMEOUT=90       # Быстрые ответы для пользователей
AI_DOCUMENT_ANALYSIS_TOKENS=3000  # Компромисс между качеством и скоростью
AI_CHAT_RESPONSE_TOKENS=1500     # Быстрые, но информативные ответы
```

## Влияние на производительность

### Положительные эффекты
- ✅ Снижение количества таймаутов
- ✅ Улучшение качества анализа
- ✅ Стабильность обработки больших документов
- ✅ Лучший пользовательский опыт

### Потенциальные риски
- ⚠️ Увеличение времени ответа для пользователей
- ⚠️ Большая нагрузка на ресурсы сервера
- ⚠️ Необходимость мониторинга производительности

## Заключение

Увеличение таймаутов и токенов AI-анализа критически важно для обеспечения качественной работы системы АДВАКОД с правовыми документами. Новые настройки обеспечивают:

1. **Надежность**: Стабильная обработка сложных документов
2. **Качество**: Глубокий анализ правовых концепций с достаточным количеством токенов
3. **Гибкость**: Настраиваемые таймауты и токены для разных сценариев
4. **Масштабируемость**: Поддержка роста объема документов
5. **Детальность**: 4000 токенов для полного анализа документов
6. **Полнота**: Достаточно места для всех правовых аспектов

Система теперь готова к работе с реальными правовыми документами любой сложности с качественным анализом и развернутыми ответами.
