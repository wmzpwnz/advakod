# Требования к миграции на модель Vistral-24B-Instruct-MLX_8bit

## Введение

Данный документ описывает требования к миграции AI-юридической системы с текущей модели Saiga (llama-cpp-python) на новую модель Vistral-24B-Instruct-MLX_8bit (https://huggingface.co/Vikhrmodels/Vistral-24B-Instruct-MLX_8bit) для развертывания на сервере Cloud-1608 (3.3 ГГц CPU, 16 ГБ RAM, 160 ГБ NVMe).

**Анализ новой модели:**
- Модель: Vistral-24B-Instruct-MLX_8bit (24B параметров, 8-bit квантизация)
- Размер: ~12-15 ГБ (8-bit квантизация)
- Фреймворк: MLX (Apple Silicon оптимизированный)
- Язык: Русский/Многоязычный
- Архитектура: Mistral-based
- Требования к памяти: ~14-16 ГБ RAM (с учетом системы)

**Проблемы совместимости:**
- MLX фреймворк оптимизирован для Apple Silicon (M1/M2/M3)
- На x86_64 серверах MLX может не работать или работать медленно
- Необходимо рассмотреть альтернативы: transformers + torch, vLLM, или GGUF конверсия

## Требования

### Требование 1: Анализ и подготовка к миграции

**Пользовательская история:** Как системный администратор, я хочу провести полный анализ текущей системы и подготовить план миграции, чтобы обеспечить безопасный переход на новую модель без потери функциональности.

#### Критерии приемки

1. КОГДА выполняется анализ системы, ТО система ДОЛЖНА идентифицировать все компоненты, зависящие от текущей модели Saiga
2. КОГДА анализируется новая модель Vistral-24B-Instruct-MLX, ТО система ДОЛЖНА определить требования к ресурсам и совместимость с MLX фреймворком
3. КОГДА создается план миграции, ТО план ДОЛЖЕН включать пошаговые инструкции по замене модели
4. КОГДА оценивается производительность, ТО система ДОЛЖНА сравнить требования к ресурсам старой и новой модели
5. ЕСЛИ обнаружены несовместимости, ТО система ДОЛЖНА предложить решения для их устранения

### Требование 2: Удаление старой модели и зависимостей

**Пользовательская история:** Как системный администратор, я хочу безопасно удалить старую модель Saiga и связанные зависимости, чтобы освободить место для новой модели и избежать конфликтов.

#### Критерии приемки

1. КОГДА удаляются файлы модели Saiga, ТО система ДОЛЖНА удалить все .gguf файлы из ~/llama.cpp/models/
2. КОГДА очищаются зависимости llama-cpp-python, ТО система ДОЛЖНА удалить пакет из requirements.txt
3. КОГДА удаляются конфигурационные файлы, ТО система ДОЛЖНА очистить все SAIGA_* переменные из .env файлов
4. КОГДА удаляются скрипты, ТО система ДОЛЖНА удалить configure_model.sh, DOWNLOAD_SAIGA_*.sh и связанные файлы
5. КОГДА очищается код, ТО система ДОЛЖНА удалить saiga_service.py и все импорты llama_cpp
6. ЕСЛИ возникают ошибки при удалении, ТО система ДОЛЖНА предоставить процедуру отката

### Требование 3: Выбор и установка подходящего фреймворка

**Пользовательская история:** Как разработчик, я хочу выбрать и установить подходящий фреймворк для работы с моделью Vistral-24B-Instruct, учитывая ограничения сервера x86_64.

#### Критерии приемки

1. КОГДА анализируется архитектура сервера, ТО система ДОЛЖНА определить, что MLX не подходит для x86_64
2. КОГДА выбирается альтернативный фреймворк, ТО система ДОЛЖНА рассмотреть: transformers+torch, vLLM, или GGUF конверсию
3. КОГДА устанавливается выбранный фреймворк, ТО система ДОЛЖНА проверить совместимость с 16 ГБ RAM
4. КОГДА тестируется установка, ТО система ДОЛЖНА выполнить пробную загрузку модели
5. ЕСЛИ выбранный фреймворк не работает, ТО система ДОЛЖНА предложить конверсию модели в GGUF формат

### Требование 4: Интеграция модели Vistral-24B-Instruct

**Пользовательская история:** Как разработчик, я хочу интегрировать модель Vistral-24B-Instruct в существующую архитектуру системы, чтобы сохранить все текущие функции и улучшить качество ответов.

#### Критерии приемки

1. КОГДА загружается модель Vistral-24B, ТО система ДОЛЖНА проверить доступность и целостность файлов модели
2. КОГДА создается новый сервис модели, ТО сервис ДОЛЖЕН реализовать тот же интерфейс (generate_response_async, stream_response, create_legal_prompt)
3. КОГДА заменяется SaigaService, ТО новый VistralService ДОЛЖЕН быть drop-in заменой
4. КОГДА тестируется интеграция, ТО система ДОЛЖНА сохранить совместимость с enhanced_rag_service
5. ЕСЛИ модель не загружается из-за нехватки памяти, ТО система ДОЛЖНА предложить дополнительную квантизацию

### Требование 5: Адаптация промптов и настроек

**Пользовательская история:** Как юрист-пользователь, я хочу получать качественные ответы от новой модели в том же формате, что и раньше, чтобы не нарушать привычный рабочий процесс.

#### Критерии приемки

1. КОГДА адаптируются промпты, ТО система ДОЛЖНА изменить формат с Saiga на Vistral (возможно ChatML или Alpaca)
2. КОГДА настраиваются параметры генерации, ТО система ДОЛЖНА найти оптимальные temperature (0.1-0.3) и top_p (0.8-0.95) для Vistral
3. КОГДА тестируются ответы на юридические вопросы, ТО качество ДОЛЖНО быть не хуже Saiga 7B
4. КОГДА обрабатываются запросы по статьям УК РФ, ТО система ДОЛЖНА сохранить точность и структуру ответов
5. ЕСЛИ качество ответов снижается, ТО система ДОЛЖНА предложить fine-tuning или дополнительные промпт-инженерные решения

### Требование 6: Оптимизация производительности

**Пользовательская история:** Как системный администратор, я хочу оптимизировать производительность новой модели под доступные ресурсы сервера, чтобы обеспечить стабильную работу системы.

#### Критерии приемки

1. КОГДА настраивается использование памяти, ТО система ДОЛЖНА не превышать 14 ГБ RAM (с резервом)
2. КОГДА оптимизируется CPU, ТО система ДОЛЖНА эффективно использовать все доступные ядра
3. КОГДА настраивается кэширование, ТО система ДОЛЖНА минимизировать время загрузки модели
4. КОГДА тестируется производительность, ТО время ответа ДОЛЖНО быть приемлемым (< 30 секунд)
5. ЕСЛИ ресурсов недостаточно, ТО система ДОЛЖНА предложить квантизацию модели

### Требование 7: Тестирование и валидация

**Пользовательская история:** Как QA-инженер, я хочу провести комплексное тестирование новой модели, чтобы убедиться в корректности работы всех функций системы.

#### Критерии приемки

1. КОГДА выполняются функциональные тесты, ТО все API эндпоинты ДОЛЖНЫ работать корректно
2. КОГДА тестируется RAG система, ТО поиск и генерация ответов ДОЛЖНЫ функционировать
3. КОГДА проводятся нагрузочные тесты, ТО система ДОЛЖНА выдерживать типичную нагрузку
4. КОГДА тестируются юридические запросы, ТО ответы ДОЛЖНЫ быть релевантными и точными
5. ЕСЛИ обнаружены ошибки, ТО система ДОЛЖНА предоставить процедуру их исправления

### Требование 8: Развертывание и мониторинг

**Пользовательская история:** Как DevOps-инженер, я хочу развернуть обновленную систему на продакшн сервере и настроить мониторинг, чтобы обеспечить стабильную работу в производственной среде.

#### Критерии приемки

1. КОГДА развертывается система, ТО процесс ДОЛЖЕН быть автоматизирован и воспроизводим
2. КОГДА настраивается мониторинг, ТО система ДОЛЖНА отслеживать использование ресурсов
3. КОГДА проверяется работоспособность, ТО все health checks ДОЛЖНЫ проходить успешно
4. КОГДА настраиваются алерты, ТО система ДОЛЖНА уведомлять о критических ошибках
5. ЕСЛИ возникают проблемы, ТО система ДОЛЖНА предоставить процедуру быстрого отката

### Требование 9: Документация и обучение

**Пользовательская история:** Как член команды, я хочу иметь актуальную документацию по новой системе, чтобы эффективно поддерживать и развивать решение.

#### Критерии приемки

1. КОГДА обновляется документация, ТО она ДОЛЖНА отражать все изменения в архитектуре
2. КОГДА создаются инструкции, ТО они ДОЛЖНЫ быть понятными для технических специалистов
3. КОГДА документируются API, ТО все изменения ДОЛЖНЫ быть описаны
4. КОГДА создается troubleshooting guide, ТО он ДОЛЖЕН покрывать типичные проблемы
5. ЕСЛИ документация неполная, ТО система ДОЛЖНА предоставить процедуру ее дополнения

### Требование 10: Резервное копирование и восстановление

**Пользовательская история:** Как системный администратор, я хочу иметь надежную систему резервного копирования, чтобы быстро восстановить работу в случае сбоев.

#### Критерии приемки

1. КОГДА создается резервная копия, ТО она ДОЛЖНА включать конфигурацию и данные
2. КОГДА тестируется восстановление, ТО процесс ДОЛЖЕН быть быстрым и надежным
3. КОГДА настраивается автоматическое резервирование, ТО оно ДОЛЖНО выполняться регулярно
4. КОГДА проверяется целостность бэкапов, ТО все файлы ДОЛЖНЫ быть доступны
5. ЕСЛИ восстановление не удается, ТО система ДОЛЖНА предоставить альтернативные методы