# План реализации миграции на Vistral-24B-Instruct-GGUF

## Обзор

Этот документ содержит пошаговый план миграции с модели Saiga 7B на Vistral-24B-Instruct-GGUF для развертывания на облачном сервере Cloud-1608 (3.3 ГГц CPU, 16 ГБ RAM, 160 ГБ NVMe).

**Важно:** Используем GGUF версию модели (не MLX), так как она полностью совместима с llama-cpp-python и работает на x86_64 архитектуре.

---

## Задачи

- [ ] 1. Подготовка и анализ системы
  - Провести аудит текущей системы и зависимостей от Saiga
  - Проверить доступные ресурсы сервера (RAM, CPU, диск)
  - Создать резервную копию текущей конфигурации и базы данных
  - Документировать все пути к файлам модели Saiga
  - _Требования: 1.1, 1.2, 1.3, 1.4_

- [ ] 2. Создание скриптов миграции
  - [ ] 2.1 Создать скрипт загрузки модели Vistral-24B-GGUF
    - Написать `download_vistral_24b.sh` с проверкой ресурсов
    - Добавить проверку доступного места на диске (минимум 20 GB)
    - Добавить проверку RAM (минимум 24 GB, рекомендуется 32 GB)
    - Реализовать загрузку с HuggingFace через wget/curl
    - Добавить проверку целостности загруженного файла
    - _Требования: 2.1, 2.3, 6.1_

  - [ ] 2.2 Создать скрипт очистки старых файлов
    - Написать `cleanup_saiga.sh` для удаления файлов Saiga
    - Удалить все .gguf файлы из ~/llama.cpp/models/
    - Очистить SAIGA_* переменные из .env файлов
    - Удалить скрипты configure_model.sh, DOWNLOAD_SAIGA_*.sh
    - Создать архив удаленных файлов для возможности отката
    - _Требования: 2.1, 2.2, 2.3, 2.4_

  - [ ] 2.3 Создать скрипт автоматического развертывания
    - Написать `deploy_vistral.sh` для полного развертывания
    - Добавить проверку SSH подключения к серверу
    - Реализовать установку Docker и Docker Compose
    - Добавить копирование файлов проекта на сервер
    - Настроить автоматическую загрузку модели
    - Добавить настройку firewall и SSL
    - _Требования: 8.1, 8.2, 8.3_

- [ ] 3. Обновление конфигурации проекта
  - [ ] 3.1 Обновить backend/app/core/config.py
    - Добавить настройки VISTRAL_MODEL_PATH
    - Добавить VISTRAL_N_CTX=8192 (увеличенный контекст)
    - Добавить VISTRAL_N_THREADS=8
    - Добавить VISTRAL_MAX_CONCURRENCY=1 (для 24B модели)
    - Добавить VISTRAL_INFERENCE_TIMEOUT=900 (15 минут)
    - Сохранить обратную совместимость с SAIGA_* переменными
    - _Требования: 4.2, 5.2, 6.1_

  - [ ] 3.2 Обновить docker-compose.prod.yml
    - Увеличить memory limits до 28G для backend
    - Увеличить memory reservations до 24G
    - Добавить VISTRAL_* переменные окружения
    - Увеличить start_period до 300s (5 минут для загрузки)
    - Настроить volume для модели: /opt/advakod/models
    - _Требования: 6.1, 6.2, 8.1_

  - [ ] 3.3 Обновить backend/.env и env.production
    - Добавить VISTRAL_MODEL_PATH=/opt/advakod/models/vistral-24b-instruct-q4_K_M.gguf
    - Добавить все VISTRAL_* параметры
    - Удалить устаревшие SAIGA_* параметры (после тестирования)
    - Обновить комментарии и документацию
    - _Требования: 2.4, 4.2_

- [ ] 4. Создание VistralService (замена SaigaService)
  - [ ] 4.1 Создать backend/app/services/vistral_service.py
    - Скопировать структуру из saiga_service.py
    - Реализовать _load_model() с параметрами Vistral
    - Реализовать generate_response_async() с оптимизацией
    - Реализовать stream_response() для потоковой генерации
    - Добавить статистику производительности
    - _Требования: 4.1, 4.2, 4.3_

  - [ ] 4.2 Адаптировать промпты для Vistral
    - Изучить формат промптов Vistral (ChatML или Alpaca)
    - Обновить create_legal_prompt() под новый формат
    - Обновить create_legal_prompt_with_history()
    - Сохранить структуру юридических инструкций
    - Протестировать качество ответов на тестовых вопросах
    - _Требования: 5.1, 5.2, 5.3, 5.4_

  - [ ] 4.3 Обновить backend/main.py
    - Заменить импорт saiga_service на vistral_service
    - Обновить load_saiga() на load_vistral()
    - Обновить app.state.models["saiga"] на ["vistral"]
    - Сохранить совместимость с существующими эндпоинтами
    - _Требования: 4.3, 4.4_

- [ ] 5. Обновление зависимостей
  - [ ] 5.1 Проверить совместимость llama-cpp-python
    - Убедиться, что текущая версия поддерживает GGUF
    - При необходимости обновить до последней версии
    - Протестировать загрузку модели локально
    - _Требования: 3.2, 3.3, 3.4_

  - [ ] 5.2 Обновить backend/requirements.txt
    - Проверить версию llama-cpp-python (должна быть >= 0.2.0)
    - Добавить комментарии о требованиях к Vistral
    - Обновить версии совместимых пакетов
    - _Требования: 3.2_

  - [ ] 5.3 Обновить backend/Dockerfile
    - Обновить установку llama-cpp-python
    - Добавить оптимизацию для CPU (если нет GPU)
    - Увеличить timeout для сборки образа
    - _Требования: 3.2, 8.1_

- [ ] 6. Тестирование локально
  - [ ] 6.1 Функциональное тестирование
    - Протестировать загрузку модели Vistral
    - Протестировать генерацию ответов на юридические вопросы
    - Протестировать потоковую генерацию (stream_response)
    - Проверить работу с RAG системой
    - Протестировать обработку ошибок
    - _Требования: 7.1, 7.2, 7.4_

  - [ ] 6.2 Тестирование производительности
    - Измерить время загрузки модели
    - Измерить время генерации ответов (должно быть < 30 сек)
    - Измерить использование памяти (должно быть < 14 GB)
    - Протестировать параллельные запросы
    - _Требования: 6.1, 6.2, 6.4, 7.3_

  - [ ] 6.3 Тестирование качества ответов
    - Протестировать ответы на статьи УК РФ
    - Протестировать ответы на вопросы о договорах
    - Протестировать ответы на вопросы о регистрации ИП
    - Сравнить качество с Saiga 7B
    - _Требования: 5.3, 5.4, 7.4_

- [ ] 7. Подготовка сервера
  - [ ] 7.1 Настроить облачный сервер
    - Создать сервер с минимум 32 GB RAM (рекомендуется)
    - Установить Ubuntu 22.04 LTS или аналог
    - Настроить SSH доступ с ключами
    - Обновить систему: apt update && apt upgrade
    - _Требования: 8.1, 8.2_

  - [ ] 7.2 Установить базовые зависимости
    - Установить Docker: curl -fsSL https://get.docker.com | sh
    - Установить Docker Compose
    - Установить wget, curl, git, htop
    - Настроить автозапуск Docker
    - _Требования: 8.1_

  - [ ] 7.3 Настроить безопасность
    - Настроить UFW firewall (порты 22, 80, 443)
    - Установить fail2ban для защиты SSH
    - Настроить автоматические обновления безопасности
    - Создать пользователя для развертывания (не root)
    - _Требования: 8.2, 8.4_

- [ ] 8. Развертывание на продакшн
  - [ ] 8.1 Загрузить проект на сервер
    - Клонировать репозиторий в /opt/advakod
    - Скопировать обновленные конфигурационные файлы
    - Создать директории: models, logs, backups, uploads
    - Установить правильные права доступа
    - _Требования: 8.1, 8.2_

  - [ ] 8.2 Загрузить модель Vistral-24B
    - Запустить download_vistral_24b.sh
    - Проверить размер файла (~15 GB)
    - Проверить целостность файла
    - Создать символическую ссылку для удобства
    - _Требования: 4.1, 8.1_

  - [ ] 8.3 Настроить окружение
    - Скопировать env.production в .env
    - Обновить SECRET_KEY и POSTGRES_PASSWORD
    - Настроить CORS_ORIGINS для продакшн домена
    - Проверить все пути к файлам
    - _Требования: 8.1, 8.2_

  - [ ] 8.4 Запустить Docker контейнеры
    - Запустить: docker-compose -f docker-compose.prod.yml up -d
    - Дождаться загрузки модели (5-10 минут)
    - Проверить логи: docker-compose logs -f backend
    - Проверить статус: docker-compose ps
    - _Требования: 8.1, 8.2, 8.3_

- [ ] 9. Настройка SSL и домена
  - [ ] 9.1 Настроить DNS
    - Добавить A-запись для домена на IP сервера
    - Добавить CNAME для www поддомена
    - Проверить распространение DNS
    - _Требования: 8.2_

  - [ ] 9.2 Настроить SSL сертификат
    - Установить certbot
    - Получить Let's Encrypt сертификат
    - Настроить автоматическое обновление
    - Обновить nginx.conf для HTTPS
    - _Требования: 8.2_

- [ ] 10. Мониторинг и тестирование продакшн
  - [ ] 10.1 Настроить мониторинг
    - Настроить health checks для всех сервисов
    - Настроить алерты на использование памяти (> 90%)
    - Настроить алерты на ошибки (error rate > 1%)
    - Настроить мониторинг времени ответа
    - _Требования: 8.2, 8.4_

  - [ ] 10.2 Провести продакшн тестирование
    - Протестировать API эндпоинты
    - Протестировать генерацию ответов
    - Протестировать RAG систему
    - Провести нагрузочное тестирование
    - _Требования: 7.1, 7.2, 7.3, 7.4_

  - [ ] 10.3 Настроить резервное копирование
    - Настроить автоматический бэкап базы данных
    - Настроить бэкап конфигурации
    - Настроить бэкап логов
    - Протестировать процедуру восстановления
    - _Требования: 10.1, 10.2, 10.3, 10.4_

- [ ] 11. Документация и обучение
  - [ ] 11.1 Обновить документацию
    - Обновить README.md с информацией о Vistral
    - Создать VISTRAL_MIGRATION_GUIDE.md
    - Обновить API документацию
    - Создать troubleshooting guide
    - _Требования: 9.1, 9.2, 9.3, 9.4_

  - [ ] 11.2 Создать операционные инструкции
    - Инструкция по развертыванию
    - Инструкция по обновлению модели
    - Инструкция по откату на Saiga
    - Инструкция по мониторингу и отладке
    - _Требования: 9.1, 9.2, 9.4_

- [ ] 12. Оптимизация и финализация
  - [ ] 12.1 Оптимизировать производительность
    - Настроить torch.compile (если используется)
    - Оптимизировать параметры генерации (temperature, top_p)
    - Настроить кэширование промптов
    - Оптимизировать использование памяти
    - _Требования: 6.1, 6.2, 6.3, 6.4_

  - [ ] 12.2 Провести финальное тестирование
    - Протестировать все функции системы
    - Провести UAT (User Acceptance Testing)
    - Собрать обратную связь от пользователей
    - Исправить найденные проблемы
    - _Требования: 7.1, 7.2, 7.3, 7.4_

  - [ ] 12.3 Удалить старые файлы Saiga
    - Удалить saiga_service.py (после подтверждения)
    - Удалить все скрипты загрузки Saiga
    - Удалить файлы модели Saiga
    - Очистить устаревшие конфигурации
    - _Требования: 2.1, 2.2, 2.3, 2.4, 2.5_

---

## Приоритеты задач

### Критические (должны быть выполнены первыми):
- 1. Подготовка и анализ системы
- 2. Создание скриптов миграции
- 3. Обновление конфигурации проекта
- 7. Подготовка сервера

### Высокий приоритет:
- 4. Создание VistralService
- 5. Обновление зависимостей
- 6. Тестирование локально

### Средний приоритет:
- 8. Развертывание на продакшн
- 9. Настройка SSL и домена
- 10. Мониторинг и тестирование продакшн

### Низкий приоритет (после успешного развертывания):
- 11. Документация и обучение
- 12. Оптимизация и финализация

---

## Оценка времени

- **Подготовка и скрипты:** 4-6 часов
- **Обновление кода:** 6-8 часов
- **Локальное тестирование:** 4-6 часов
- **Подготовка сервера:** 2-3 часа
- **Развертывание:** 3-4 часа
- **Тестирование продакшн:** 4-6 часов
- **Документация:** 3-4 часа
- **Оптимизация:** 4-6 часов

**Общее время:** 30-43 часа (4-6 рабочих дней)

---

## Критерии успеха

✅ Модель Vistral-24B успешно загружена и работает
✅ Время ответа < 30 секунд на типичные запросы
✅ Использование памяти < 28 GB (из 32 GB)
✅ Качество ответов не хуже Saiga 7B
✅ Все API эндпоинты работают корректно
✅ RAG система интегрирована и функционирует
✅ Система стабильна (uptime > 99%)
✅ Документация обновлена и актуальна

---

## Процедура отката

В случае критических проблем:

1. Остановить Docker контейнеры
2. Восстановить старую конфигурацию из бэкапа
3. Вернуть файлы модели Saiga
4. Откатить изменения в коде (git revert)
5. Перезапустить систему с Saiga

**Время отката:** ~30-60 минут